<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phaser Key Input Example</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* 스크롤 방지 */
            background-color: bisque; /* 배경색 */
            display: flex; /* 플렉스 박스 레이아웃 사용 */
            flex-direction: column; /* 세로 방향으로 배치 */
            align-items: center; /* 중앙 정렬 */
            justify-content: center; /* 중앙 정렬 */
        }
        #header {
            background-color: indianred; /* 헤더 배경색 */
            color: #fff; /* 헤더 텍스트 색 */
            width: 100%; /* 전체 너비 */
            padding: 10px; /* 여백 */
            text-align: center; /* 중앙 정렬 */
        }
        #chatBox {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            height: 200px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            overflow-y: scroll; /* 스크롤 가능 */
            padding: 10px;
            border-radius: 5px;
        }
        #chatInput {
            position: absolute;
            bottom: 220px;
            left: 10px;
            width: 300px;
        }
    </style>
</head>
<body>
<div id="header">Welcome to My 2D-Game!!!</div>
<div id="chatBox"></div>
<input type="text" id="chatInput" placeholder="채팅 입력 후 엔터" />

<script>
    // 각 사용자를 위한 고유 6자리 ID 생성
    function generateId() {
        return Math.random().toString(36).substring(2, 8);
    }

    const sessionId = generateId(); // 고유 세션 ID 생성
    console.log("사용자 ID:", sessionId);

    // 웹소켓 연결
    const socket = new WebSocket("ws://localhost:8080/websocket");

    socket.onopen = function() {
        console.log("웹소켓 연결이 설정되었습니다.");
        // 사용자 ID를 서버에 전송
        socket.send(JSON.stringify({ id: sessionId }));
        addChatMessage(`Welcome! You are connected with session ID: ${sessionId}`); // 환영 메시지 추가
    };

    socket.onmessage = function(event) {
        console.log(event.data);  // 받은 메시지를 로그에 출력

        // 수신한 데이터에서 JSON 부분만 추출
        const jsonStartIndex = event.data.indexOf(':') + 1; // ':' 이후의 인덱스부터 시작
        const jsonString = event.data.substring(jsonStartIndex).trim(); // JSON 문자열 추출 및 공백 제거

        // JSON 데이터인지 확인하기 위한 조건문
        if (jsonString.startsWith('{') && jsonString.endsWith('}')) {
            try {
                const data = JSON.parse(jsonString); // JSON 파싱

                if (data.message) {
                    // 채팅 메시지 처리
                    addChatMessage(`${data.id}: ${data.message}`); // 채팅 박스에 추가
                } else {
                    updateOtherPlayers(data); // 다른 플레이어 업데이트
                }
            } catch (error) {
                console.error("JSON 파싱 오류:", error);
                console.log("받은 데이터:", event.data);
            }
        } else {
            console.log("JSON이 아닌 데이터 수신:", event.data);
        }
    };

    socket.onerror = function(error) {
        console.error("웹소켓 오류:", error);
    };

    function sendPosition(x, y) {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ id: sessionId, x: x, y: y }));
        }
    }

    function sendChatMessage(message) {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ id: sessionId, message: message }));
        }
    }

    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    const game = new Phaser.Game(config);

    let player; // 플레이어 변수
    let playerSprite; // 플레이어 스프라이트 변수
    let cursors; // 방향키 변수
    let otherPlayers = {}; // 다른 플레이어들 정보 저장 객체

    let lastSentPosition = { x: null, y: null };  // 마지막으로 보낸 위치 저장
    let positionText; // 플레이어 좌표를 표시할 텍스트 변수

    function preload() {
        // 스프라이트 시트 로드 (프레임 크기: 48x48)
        this.load.spritesheet('cat', '/assets/images/cat_walk.png', { frameWidth: 48, frameHeight: 48 });
        this.load.image('bg_day', '/assets/images/bg_day.png'); // 배경 이미지 로드
    }

    function create() {
        // 배경 이미지 추가
        this.add.image(400, 300, 'bg_day').setOrigin(0.5, 0.5).setDisplaySize(800, 600); // 배경 이미지 위치와 크기 설정

        // 플레이어 스프라이트 생성
        playerSprite = this.physics.add.sprite(400, 576, 'cat');
        playerSprite.setOrigin(0.5, 0.5); // 스프라이트 중앙 정렬
        playerSprite.body.setCollideWorldBounds(true); // 월드 경계에서 벗어나는 것을 방지

        // 애니메이션 생성
        this.anims.create({
            key: 'walk',
            frames: this.anims.generateFrameNumbers('cat', { start: 0, end: 5 }), // 6개 프레임
            frameRate: 10,
            repeat: -1 // 반복 재생
        });

        // 플레이어 ID 텍스트 생성
        player = this.add.text(400, 60, sessionId, { fontSize: '20px', fill: '#FFFFFF' });
        player.setOrigin(0.5, 0.5); // 텍스트 중앙 정렬
        player.setScrollFactor(0); // 화면에 고정되도록 설정

        // 카메라 설정: 플레이어를 따라다니도록 설정
        this.cameras.main.startFollow(playerSprite, false, 1, 0); // 가로는 따라다니고 세로는 고정 (lerpX: 1, lerpY: 0)
        this.cameras.main.setBounds(0, 0, 1600, 600); // 가로 범위는 설정하고, 세로는 600으로 고정

        // 플레이어 좌표 표시 텍스트 생성
        positionText = this.add.text(400, 20, '', { fontSize: '18px', fill: '#ffffff' });
        positionText.setOrigin(0.5, 0); // 텍스트 중앙 정렬
        positionText.setScrollFactor(0); // 카메라와 함께 움직이도록 설정

        // 방향키 설정
        cursors = this.input.keyboard.createCursorKeys();

        // 채팅 입력 이벤트
        document.getElementById("chatInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                const message = this.value.trim();
                if (message) {
                    sendChatMessage(message); // 채팅 메시지 전송
                    this.value = ''; // 입력창 비우기
                }
            }
        });
    }

    function update() {
        playerSprite.body.setVelocity(0);

        let moved = false;

        if (cursors.left.isDown) {
            playerSprite.body.setVelocityX(-160);
            moved = true;
            playerSprite.anims.play('walk', true); // 애니메이션 재생
            playerSprite.setFlipX(true); // 왼쪽으로 움직일 때 스프라이트 반전
        } else if (cursors.right.isDown) {
            playerSprite.body.setVelocityX(160);
            moved = true;
            playerSprite.anims.play('walk', true); // 애니메이션 재생
            playerSprite.setFlipX(false); // 오른쪽으로 움직일 때 스프라이트 반전 해제
        }

        if (cursors.up.isDown) {
            playerSprite.body.setVelocityY(-160);
            moved = true;
            playerSprite.anims.play('walk', true); // 애니메이션 재생
        } else if (cursors.down.isDown) {
            playerSprite.body.setVelocityY(160);
            moved = true;
            playerSprite.anims.play('walk', true); // 애니메이션 재생
        }

        if (!moved) {
            playerSprite.anims.stop(); // 정지 시 애니메이션 멈춤
        }

        if (moved && (playerSprite.x !== lastSentPosition.x || playerSprite.y !== lastSentPosition.y)) {
            sendPosition(playerSprite.x, playerSprite.y);
            lastSentPosition = { x: playerSprite.x, y: playerSprite.y };  // 마지막 전송된 위치 업데이트
        }

        // 현재 플레이어 좌표 업데이트
        positionText.setText(`X: ${Math.round(playerSprite.x)}, Y: ${Math.round(playerSprite.y)}`);
    }

    function updateOtherPlayers(data) {
        if (data.id !== sessionId) { // 자신이 보낸 메시지는 무시
            if (!otherPlayers[data.id]) {
                // 다른 플레이어가 없으면 새로 생성
                otherPlayers[data.id] = createPlayer(data.x, data.y, data.id);
            } else {
                // 기존 플레이어가 있으면 위치 업데이트
                otherPlayers[data.id].setPosition(data.x, data.y);
            }
        }
    }

    function createPlayer(x, y, id) {
        let newPlayerText = game.scene.scenes[0].add.text(x, y, id, { fontSize: '20px', fill: '#ffffff' });
        newPlayerText.setOrigin(0.5, 0.5); // 텍스트 중앙 정렬
        return newPlayerText;
    }

    function addChatMessage(message) {
        const chatBox = document.getElementById("chatBox");
        const messageElement = document.createElement("div");
        messageElement.textContent = message;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight; // 스크롤을 아래로
    }

</script>
</body>
</html>
