<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phaser Key Input Example</title>
    <!-- Phaser.js 라이브러리 로드 -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* 스크롤 방지 */
        }
    </style>
</head>
<body>
<script>

    // 웹소켓 연결
    const socket = new WebSocket("ws://localhost:8080/websocket");

    socket.onopen = function() {
        console.log("WebSocket connection established");
    };

    socket.onmessage = function(event) {
        console.log(event.data);  // 받은 메시지를 확인

        // 메시지가 JSON으로 시작하는지 확인하는 조건 추가
        if (event.data.trim().startsWith("{")) {
            try {
                // 콜론(:)을 기준으로 메시지를 분리
                const [id, jsonData] = event.data.split(/:(.+)/);  // ID와 JSON 데이터 분리
                const data = JSON.parse(jsonData);  // JSON 데이터 파싱

                // 이후 로직 처리
                console.log("ID:", id);  // ID 출력
                console.log("Parsed Data:", data);  // 파싱된 데이터 출력

                updateOtherPlayers(data);  // 받은 데이터를 통해 다른 플레이어 업데이트
            } catch (error) {
                console.error("JSON parsing error:", error);
                console.log("Received data:", event.data);
            }
        } else {
            // JSON이 아닌 일반 텍스트 메시지 처리
            console.log("Received non-JSON message:", event.data);
        }
    };

    socket.onerror = function(error) {
        console.error("WebSocket error:", error);
    };

    // 위치 전송
    function sendPosition(x, y) {
        if (socket.readyState === WebSocket.OPEN) {  // WebSocket이 연결되어 있는지 확인
            socket.send(JSON.stringify({ x: x, y: y }));
        }
    }

    // 게임 설정
    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    const game = new Phaser.Game(config); // 게임 인스턴스 생성

    let player; // 플레이어 변수
    let cursors; // 방향키 변수
    let otherPlayers = {}; // 다른 플레이어들 정보 저장 객체

    let lastSentPosition = { x: null, y: null };  // 마지막으로 보낸 위치 저장

    // 자원 로드
    function preload() {
        this.load.image('player', 'images/logoG.png'); // 플레이어 스프라이트 로드 (Phaser 로고 이미지)
    }

    // 게임 생성
    function create() {
        // 플레이어 생성
        player = this.physics.add.sprite(400, 300, 'player');
        player.setCollideWorldBounds(true); // 월드 경계에서 충돌 방지

        // 방향키 입력 설정
        cursors = this.input.keyboard.createCursorKeys(); // 방향키 입력 생성
    }

    // 게임 업데이트
    function update() {
        player.setVelocity(0);

        let moved = false; // 플레이어가 움직였는지 여부

        if (cursors.left.isDown) {
            player.setVelocityX(-160);
            moved = true;
        } else if (cursors.right.isDown) {
            player.setVelocityX(160);
            moved = true;
        }

        if (cursors.up.isDown) {
            player.setVelocityY(-160);
            moved = true;
        } else if (cursors.down.isDown) {
            player.setVelocityY(160);
            moved = true;
        }

        // 위치가 변경되었을 때만 전송
        if (moved && (player.x !== lastSentPosition.x || player.y !== lastSentPosition.y)) {
            sendPosition(player.x, player.y);
            lastSentPosition = { x: player.x, y: player.y };  // 마지막 전송된 위치 업데이트
        }
    }

    // 다른 플레이어의 위치 업데이트 함수
    function updateOtherPlayers(data) {
        // 받은 데이터에 기반해 다른 플레이어 생성 또는 이동 처리
        if (!otherPlayers[data.id]) {
            // 다른 플레이어가 없으면 새로 생성
            otherPlayers[data.id] = createPlayer(data.x, data.y);
        } else {
            // 기존 플레이어가 있으면 위치 업데이트
            otherPlayers[data.id].x = data.x;
            otherPlayers[data.id].y = data.y;
        }
    }

    // 다른 플레이어 생성 함수
    function createPlayer(x, y) {
        let newPlayer = game.scene.scenes[0].physics.add.sprite(x, y, 'player');
        newPlayer.setCollideWorldBounds(true);
        return newPlayer;
    }

</script>
</body>
</html>
