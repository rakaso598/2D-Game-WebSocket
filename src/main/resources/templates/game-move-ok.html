<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phaser Key Input Example</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden; /* 스크롤 방지 */
        }
    </style>
</head>
<body>
<script>
    // 각 사용자를 위한 고유 6자리 ID 생성
    function generateId() {
        return Math.random().toString(36).substring(2, 8);
    }

    const sessionId = generateId(); // 고유 세션 ID 생성
    console.log("사용자 ID:", sessionId);

    // 웹소켓 연결
    const socket = new WebSocket("ws://localhost:8080/websocket");

    socket.onopen = function() {
        console.log("웹소켓 연결이 설정되었습니다.");
        // 사용자 ID를 서버에 전송
        socket.send(JSON.stringify({ id: sessionId }));
    };

    socket.onmessage = function(event) {
        console.log(event.data);  // 받은 메시지를 로그에 출력

        // 수신한 데이터에서 JSON 부분만 추출
        const jsonStartIndex = event.data.indexOf(':') + 1; // ':' 이후의 인덱스부터 시작
        const jsonString = event.data.substring(jsonStartIndex).trim(); // JSON 문자열 추출 및 공백 제거

        // JSON 데이터인지 확인하기 위한 조건문
        if (jsonString.startsWith('{') && jsonString.endsWith('}')) {
            try {
                const data = JSON.parse(jsonString); // JSON 파싱
                updateOtherPlayers(data); // 다른 플레이어 업데이트
            } catch (error) {
                console.error("JSON 파싱 오류:", error);
                console.log("받은 데이터:", event.data);
            }
        } else {
            console.log("JSON이 아닌 데이터 수신:", event.data);
        }
    };

    socket.onerror = function(error) {
        console.error("웹소켓 오류:", error);
    };

    function sendPosition(x, y) {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ id: sessionId, x: x, y: y }));
        }
    }

    const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    const game = new Phaser.Game(config);

    let player; // 플레이어 변수
    let cursors; // 방향키 변수
    let otherPlayers = {}; // 다른 플레이어들 정보 저장 객체

    let lastSentPosition = { x: null, y: null };  // 마지막으로 보낸 위치 저장

    function preload() {
        // 로드할 이미지가 없으므로 비워둡니다.
    }

    function create() {
        // 플레이어 텍스트 생성
        player = this.add.text(400, 300, sessionId, { fontSize: '32px', fill: '#ffffff' });
        player.setOrigin(0.5, 0.5); // 텍스트 중앙 정렬
        this.physics.add.existing(player); // 텍스트 객체에 물리 추가
        player.body.setCollideWorldBounds(true); // 월드 경계에서 벗어나는 것을 방지

        // 방향키 설정
        cursors = this.input.keyboard.createCursorKeys();
    }

    function update() {
        player.body.setVelocity(0);

        let moved = false;

        if (cursors.left.isDown) {
            player.body.setVelocityX(-160);
            moved = true;
        } else if (cursors.right.isDown) {
            player.body.setVelocityX(160);
            moved = true;
        }

        if (cursors.up.isDown) {
            player.body.setVelocityY(-160);
            moved = true;
        } else if (cursors.down.isDown) {
            player.body.setVelocityY(160);
            moved = true;
        }

        if (moved && (player.x !== lastSentPosition.x || player.y !== lastSentPosition.y)) {
            sendPosition(player.x, player.y);
            lastSentPosition = { x: player.x, y: player.y };  // 마지막 전송된 위치 업데이트
        }
    }

    function updateOtherPlayers(data) {
        if (data.id !== sessionId) { // 자신이 보낸 메시지는 무시
            if (!otherPlayers[data.id]) {
                // 다른 플레이어가 없으면 새로 생성
                otherPlayers[data.id] = createPlayer(data.x, data.y, data.id);
            } else {
                // 기존 플레이어가 있으면 위치 업데이트
                otherPlayers[data.id].setPosition(data.x, data.y);
            }
        }
    }

    function createPlayer(x, y, id) {
        let newPlayerText = game.scene.scenes[0].add.text(x, y, id, { fontSize: '32px', fill: '#ffffff' });
        newPlayerText.setOrigin(0.5, 0.5); // 텍스트 중앙 정렬
        return newPlayerText;
    }

</script>
</body>
</html>
